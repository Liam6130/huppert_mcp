# CLAUDE.md - Huppert MCP Project Guide

## Project Overview

This is an MCP (Model Context Protocol) server that exposes the NIRS-Toolbox (a MATLAB-based fNIRS data analysis toolbox) to AI assistants. The server parses MATLAB source files from the toolbox and provides structured access to modules, workflows, demos, and documentation via MCP resources, tools, and prompts.

- **Language**: Python 3.10+
- **Framework**: MCP (`mcp[cli]`) using `FastMCP`
- **Version**: v1.2
- **License**: MIT
- **Author**: Liam

## Repository Structure

```
huppert_mcp/
├── nirs_toolbox_mcp.py       # Main MCP server (single-file application)
├── setup.sh                  # Automated installation script
├── package.sh                # Distribution packaging script
├── requirements.txt          # Python dependencies (mcp, httpx, pydantic)
├── .gitignore
├── README.md                 # Project overview (Chinese)
├── START_HERE.md             # Quick start guide
├── CHANGELOG.md              # Version history
├── DISTRIBUTION.md           # Distribution instructions
├── LICENSE                   # MIT license
├── docs/                     # Documentation (mostly Chinese)
│   ├── DOCS_INDEX.md         # Documentation navigation index
│   ├── README.md
│   ├── USER_GUIDE.md
│   ├── NIRS_MCP_完整指南.md
│   ├── NIRS_MCP_快速入门.md
│   ├── MCP问题诊断与解决.md
│   └── AR-IRLS_Math_模块说明文档.md
└── tests/
    └── test_nirs_mcp.py      # Basic integration tests
```

## Architecture

The entire server is a single Python file (`nirs_toolbox_mcp.py`) organized into 6 sections:

1. **Configuration** (lines 17-48) - MCP server init, `NIRS_TOOLBOX_PATH` env var handling, path validation
2. **Helper Functions** (lines 50-219) - MATLAB file parsing (`parse_matlab_class`, `parse_property_line`, `extract_method_comment`, `parse_matlab_function`), namespace traversal, formatting
3. **Resources** (lines ~293-456) - MCP resources for browsing categories, modules, and demos
4. **Tools** (lines ~462-880) - `search_module`, `find_workflow`, `get_module_details`, `compare_modules`
5. **Prompts** (lines ~886-963) - Guided templates for preprocessing, GLM analysis, data loading, pipeline building
6. **Server Startup** (lines ~970-980) - Entry point with `mcp.run(transport="stdio")`

Key design decisions:
- All MATLAB parsing uses regex (no external MATLAB dependency at runtime)
- Files are read with `encoding='utf-8', errors='ignore'` for robustness
- Output is formatted as Markdown for LLM consumption
- The server communicates over stdio transport
- The `NIRS_TOOLBOX_PATH` environment variable is required (falls back to a hardcoded default path)

## Dependencies

Defined in `requirements.txt`:
- `mcp[cli]>=1.0.0` - MCP server framework
- `httpx>=0.28.0` - HTTP client (MCP dependency)
- `pydantic>=2.10.0` - Data validation (MCP dependency)

No dev dependencies, linter, formatter, or type checker is configured.

## Setup and Running

```bash
# Install (interactive - prompts for NIRS-Toolbox path)
./setup.sh

# Run manually
export NIRS_TOOLBOX_PATH=/path/to/nirs-toolbox
python3 nirs_toolbox_mcp.py
```

The server is designed to be launched by Cursor IDE via the MCP configuration in `~/.cursor/mcp.json`. It is not run standalone in production.

## Testing

```bash
python3 tests/test_nirs_mcp.py
```

Tests are a custom script (not using pytest or unittest). They verify:
- Server file existence
- Toolbox path validity
- Dependency installation (`mcp` module import)
- Server startup via subprocess
- Claude Desktop configuration

**Note**: The test file contains hardcoded macOS paths (`/Users/liam/...`). Tests require access to the actual NIRS-Toolbox installation to pass.

## Key Conventions

- **Language**: Documentation and code comments are primarily in Chinese. Keep new contributions consistent with existing language usage.
- **Single-file architecture**: All server logic is in `nirs_toolbox_mcp.py`. Do not split into multiple modules without discussion.
- **MCP decorators**: Resources use `@mcp.resource()`, tools use `@mcp.tool()`, prompts use `@mcp.prompt()`.
- **Output format**: All tool/resource return values are Markdown strings with emoji headers.
- **Error messages**: Use emoji prefixes (`✅`, `❌`, `⚠️`) for status indicators.
- **MATLAB parsing**: Uses regex-based parsing. The `+nirs` namespace directory is the root for module discovery.
- **No CI/CD**: There is no automated CI pipeline. Test locally before committing.
- **Generated files**: `config.json` and `cursor_mcp_config.json` are generated by `setup.sh` and gitignored.

## Common Tasks

### Adding a new MCP tool
Add a new function decorated with `@mcp.tool()` in section 4 of `nirs_toolbox_mcp.py`. Follow the existing pattern with Chinese docstrings and Markdown return format.

### Adding a new MCP resource
Add a new function decorated with `@mcp.resource()` in section 3. Use the URI pattern matching existing resources (e.g., `module://{category}/{name}`).

### Adding a new prompt template
Add a new function decorated with `@mcp.prompt()` in section 5. Return a string template with placeholder sections for user input.

### Packaging for distribution
```bash
./package.sh
```
Creates a `.tar.gz` archive with SHA256 checksum.
